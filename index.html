<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Color Geo Guesser</title>
    <!-- Tailwind via CDN (JIT) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  </head>
  <body class="bg-slate-900 text-slate-100">
    <div id="root"></div>

    <script>
      const { useEffect, useMemo, useRef, useState } = React;

      // ===================== Utils =====================
      function hashString(str) {
        let h = 2166136261 >>> 0;
        for (let i = 0; i < str.length; i++) {
          h ^= str.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return h >>> 0;
      }

      function makePRNG(seed) {
        let s = seed >>> 0;
        return function () {
          s ^= s << 13;
          s ^= s >>> 17;
          s ^= s << 5;
          return (s >>> 0) / 0xffffffff;
        };
      }

      function hslToRgb(h, s, l) {
        const c = (1 - Math.abs(2 * l - 1)) * s;
        const hp = h / 60;
        const x = c * (1 - Math.abs((hp % 2) - 1));
        let r1 = 0, g1 = 0, b1 = 0;
        if (hp >= 0 && hp < 1) [r1, g1, b1] = [c, x, 0];
        else if (hp < 2) [r1, g1, b1] = [x, c, 0];
        else if (hp < 3) [r1, g1, b1] = [0, c, x];
        else if (hp < 4) [r1, g1, b1] = [0, x, c];
        else if (hp < 5) [r1, g1, b1] = [x, 0, c];
        else [r1, g1, b1] = [c, 0, x];
        const m = l - c / 2;
        const r = Math.round((r1 + m) * 255);
        const g = Math.round((g1 + m) * 255);
        const b = Math.round((b1 + m) * 255);
        return { r, g, b };
      }

      function rgbToXyz({ r, g, b }) {
        const srgb = [r, g, b]
          .map((v) => v / 255)
          .map((v) => (v <= 0.04045 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4)));
        const [R, G, B] = srgb;
        const X = R * 0.4124564 + G * 0.3575761 + B * 0.1804375;
        const Y = R * 0.2126729 + G * 0.7151522 + B * 0.072175;
        const Z = R * 0.0193339 + G * 0.119192 + B * 0.9503041;
        return { X, Y, Z };
      }

      function xyzToLab({ X, Y, Z }) {
        const ref = { X: 0.95047, Y: 1.0, Z: 1.08883 };
        const f = (t) => (t > 0.008856 ? Math.cbrt(t) : 7.787037 * t + 16 / 116);
        const fx = f(X / ref.X);
        const fy = f(Y / ref.Y);
        const fz = f(Z / ref.Z);
        const L = 116 * fy - 16;
        const a = 500 * (fx - fy);
        const b = 200 * (fy - fz);
        return { L, a, b };
      }

      function deltaE76(lab1, lab2) {
        const dL = lab1.L - lab2.L;
        const da = lab1.a - lab2.a;
        const db = lab1.b - lab2.b;
        return Math.sqrt(dL * dL + da * da + db * db);
      }

      function hexFromHSL(h, s, l) {
        const { r, g, b } = hslToRgb(h, s, l);
        return `#${[r, g, b].map((v) => v.toString(16).padStart(2, "0")).join("")}`;
      }

      function labFromHsl(h, s, l) {
        const rgb = hslToRgb(h, s, l);
        return xyzToLab(rgbToXyz(rgb));
      }

      function percentageFromColors(target, guess) {
        const dE = deltaE76(labFromHsl(...target), labFromHsl(...guess));
        const pct = Math.max(0, 100 * (1 - Math.min(dE / 100, 1)));
        return Math.round(pct);
      }

      function generateDailyColors(count = 5) {
        const today = new Date();
        const key = `${today.getUTCFullYear()}-${today.getUTCMonth() + 1}-${today.getUTCDate()}`;
        const seed = hashString("COLOR-GEO-GUESSER-IT-DAILY-" + key);
        const rnd = makePRNG(seed);
        const colors = [];
        for (let i = 0; i < count; i++) {
          const h = Math.floor(rnd() * 360);
          const s = 0.55 + rnd() * 0.35;
          const l = 0.35 + rnd() * 0.35;
          colors.push([h, s, l]);
        }
        return { colors, key };
      }

      // ===================== ColorWheel (canvas) =====================
      function ColorWheel({ h, s, onChange, className }) {
        const canvasRef = useRef(null);
        const pointerRef = useRef({ x: 0, y: 0, down: false });

        const draw = () => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          const ctx = canvas.getContext("2d");
          if (!ctx) return;

          const width = Math.max(1, Math.floor(canvas.width));
          const height = Math.max(1, Math.floor(canvas.height));
          if (!Number.isFinite(width) || !Number.isFinite(height) || width <= 0 || height <= 0) return;

          const size = Math.min(width, height);
          const radius = size / 2;
          const cx = radius, cy = radius;

          const img = ctx.createImageData(size, size);
          const data = img.data;

          for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
              const dx = x - cx, dy = y - cy;
              const dist = Math.sqrt(dx * dx + dy * dy);
              if (dist <= radius) {
                const sat = dist / radius;
                let ang = Math.atan2(dy, dx);
                ang = (ang * 180) / Math.PI + 90;
                if (ang < 0) ang += 360;
                const { r, g, b } = hslToRgb(ang, sat, 0.5);
                const idx = (y * size + x) * 4;
                data[idx] = r; data[idx + 1] = g; data[idx + 2] = b; data[idx + 3] = 255;
              }
            }
          }
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.putImageData(img, 0, 0);
          ctx.beginPath();
          ctx.arc(cx, cy, radius - 1, 0, Math.PI * 2);
          ctx.strokeStyle = "rgba(255,255,255,0.25)";
          ctx.lineWidth = 2;
          ctx.stroke();
        };

        useEffect(() => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          const parent = canvas.parentElement;

          const resize = () => {
            if (!parent) return;
            const cssSize = Math.max(120, Math.min(parent.clientWidth, 420));
            const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
            const px = Math.max(1, Math.floor(cssSize * dpr));
            canvas.width = px;
            canvas.height = px;
            canvas.style.width = cssSize + "px";
            canvas.style.height = cssSize + "px";

            draw();
            const r = (cssSize / 2) * s;
            const ang = (h - 90) * (Math.PI / 180);
            pointerRef.current.x = cssSize / 2 + r * Math.cos(ang);
            pointerRef.current.y = cssSize / 2 + r * Math.sin(ang);
          };

          resize();
          let ro;
          if (typeof ResizeObserver !== "undefined") {
            ro = new ResizeObserver(resize);
            ro.observe(parent);
          } else {
            window.addEventListener("resize", resize);
          }
          return () => {
            if (ro) ro.disconnect();
            else window.removeEventListener("resize", resize);
          };
        }, []); // init

        useEffect(() => { draw(); }, [h, s]); // redraw wheel when values change

        useEffect(() => {
          const canvas = canvasRef.current;
          if (!canvas) return;

          const handle = (clientX, clientY) => {
            const rect = canvas.getBoundingClientRect();
            if (!rect.width || !rect.height) return;
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            const size = Math.min(rect.width, rect.height);
            const cx = size / 2, cy = size / 2;
            const dx = x - cx, dy = y - cy;
            let dist = Math.sqrt(dx * dx + dy * dy);
            const radius = size / 2;
            if (dist > radius) dist = radius;
            const sat = radius ? dist / radius : 0;
            let ang = Math.atan2(dy, dx);
            ang = (ang * 180) / Math.PI + 90;
            if (ang < 0) ang += 360;

            onChange({ h: ang, s: sat });
            pointerRef.current.x = x;
            pointerRef.current.y = y;
          };

          const onDown = (e) => {
            pointerRef.current.down = true;
            if (e.touches) {
              const t = e.touches[0];
              handle(t.clientX, t.clientY);
            } else {
              handle(e.clientX, e.clientY);
            }
          };
          const onMove = (e) => {
            if (!pointerRef.current.down) return;
            if (e.touches) {
              const t = e.touches[0];
              handle(t.clientX, t.clientY);
            } else {
              handle(e.clientX, e.clientY);
            }
          };
          const onUp = () => (pointerRef.current.down = false);

          canvas.addEventListener("mousedown", onDown);
          window.addEventListener("mousemove", onMove);
          window.addEventListener("mouseup", onUp);
          canvas.addEventListener("touchstart", onDown, { passive: true });
          window.addEventListener("touchmove", onMove, { passive: true });
          window.addEventListener("touchend", onUp, { passive: true });

          return () => {
            canvas.removeEventListener("mousedown", onDown);
            window.removeEventListener("mousemove", onMove);
            window.removeEventListener("mouseup", onUp);
            canvas.removeEventListener("touchstart", onDown);
            window.removeEventListener("touchmove", onMove);
            window.removeEventListener("touchend", onUp);
          };
        }, [onChange]);

        return React.createElement(
          "div",
          { className: "relative" + (className ? " " + className : "") },
          React.createElement("canvas", {
            ref: canvasRef,
            className: "rounded-full shadow-inner border border-slate-700 block mx-auto",
          }),
          React.createElement("div", {
            className:
              "pointer-events-none absolute -translate-x-1/2 -translate-y-1/2 w-6 h-6 rounded-full border-4 border-white shadow",
            style: { left: pointerRef.current.x || "50%", top: pointerRef.current.y || "50%" },
          })
        );
      }

      // ===================== App (Game) =====================
      function App() {
        const { colors: targets, key: dailyKey } = React.useMemo(() => generateDailyColors(5), []);
        const [round, setRound] = useState(0);
        const [finished, setFinished] = useState(false);
        const [h, setH] = useState(200);
        const [s, setS] = useState(0.6);
        const [l, setL] = useState(0.5);
        const [scores, setScores] = useState([]);
        const [locked, setLocked] = useState(false);

        const target = targets[Math.min(round, 4)];
        const targetHex = hexFromHSL(target[0], target[1], target[2]);
        const guessHex = hexFromHSL(h, s, l);

        const onWheelChange = ({ h: nh, s: ns }) => {
          if (locked) return;
          setH(nh); setS(ns);
        };

        const onGuess = () => {
          if (locked) return;
          const pct = percentageFromColors(target, [h, s, l]);
          setScores((prev) => [...prev, pct]);
          setLocked(true);
          if (round >= 4) setFinished(true);
        };

        const onNext = () => {
          if (!locked) return;
          if (round < 4) {
            setRound((r) => r + 1);
            setLocked(false);
          } else {
            setFinished(true);
          }
        };

        const avg = scores.length ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;

        return React.createElement(
          "div",
          { className: "min-h-[100vh] w-full flex items-start justify-center py-10" },
          React.createElement(
            "div",
            { className: "w-full max-w-5xl rounded-3xl bg-slate-800/60 p-6 md:p-10 shadow-2xl border border-slate-700" },
            React.createElement(
              "div",
              { className: "text-center" },
              React.createElement("h1", { className: "text-3xl md:text-4xl font-extrabold tracking-tight" }, "Color Geo Guesser"),
              React.createElement("p", { className: "text-slate-300 mt-1" }, "Indovina il colore in 5 round. Nuovi colori ogni giorno (chiave: ", dailyKey, ").")
            ),

            !finished &&
              React.createElement(
                "div",
                { className: "grid md:grid-cols-2 gap-8 mt-10" },
                React.createElement(
                  "div",
                  null,
                  React.createElement("h3", { className: "text-lg font-semibold mb-3" }, `Colore da abbinare (Round ${round + 1}/5)`),
                  React.createElement("div", {
                    className: "aspect-square rounded-2xl shadow-inner border border-slate-700",
                    style: { background: targetHex },
                  })
                ),
                React.createElement(
                  "div",
                  null,
                  React.createElement("h3", { className: "text-lg font-semibold mb-3" }, "Scegli con la ruota"),
                  React.createElement(ColorWheel, { h, s, onChange: onWheelChange }),
                  React.createElement(
                    "div",
                    { className: "mt-4" },
                    React.createElement(
                      "label",
                      { className: "text-sm text-slate-300 flex justify-between" },
                      React.createElement("span", null, "Tonalità (Hue)"),
                      React.createElement("span", null, Math.round(h), "°")
                    ),
                    React.createElement("input", {
                      type: "range", min: 0, max: 360, step: 1, value: h,
                      onChange: (e) => !locked && setH(parseFloat(e.target.value)),
                      className: "w-full", disabled: locked
                    })
                  ),
                  React.createElement(
                    "div",
                    { className: "mt-4" },
                    React.createElement(
                      "label",
                      { className: "text-sm text-slate-300 flex justify-between" },
                      React.createElement("span", null, "Saturazione"),
                      React.createElement("span", null, Math.round(s * 100), "%")
                    ),
                    React.createElement("input", {
                      type: "range", min: 0, max: 1, step: 0.01, value: s,
                      onChange: (e) => !locked && setS(parseFloat(e.target.value)),
                      className: "w-full", disabled: locked
                    })
                  ),
                  React.createElement(
                    "div",
                    { className: "mt-4" },
                    React.createElement(
                      "label",
                      { className: "text-sm text-slate-300 flex justify-between" },
                      React.createElement("span", null, "Luminosità"),
                      React.createElement("span", null, Math.round(l * 100), "%")
                    ),
                    React.createElement("input", {
                      type: "range", min: 0, max: 1, step: 0.01, value: l,
                      onChange: (e) => setL(parseFloat(e.target.value)),
                      className: "w-full"
                    })
                  ),
                  React.createElement(
                    "div",
                    { className: "mt-4" },
                    React.createElement("div", {
                      className: "aspect-[3/1] rounded-2xl border border-slate-700",
                      style: { background: guessHex },
                    })
                  ),
                  React.createElement(
                    "div",
                    { className: "mt-6 flex gap-3" },
                    React.createElement(
                      "button",
                      {
                        disabled: locked,
                        onClick: onGuess,
                        className:
                          "px-4 py-2 rounded-xl font-semibold shadow " +
                          ( !locked ? "bg-emerald-500 hover:brightness-110" : "bg-slate-600 cursor-not-allowed" ),
                      },
                      "Guess"
                    ),
                    React.createElement(
                      "button",
                      {
                        disabled: !locked,
                        onClick: onNext,
                        className:
                          "px-4 py-2 rounded-xl font-semibold shadow " +
                          ( locked ? "bg-sky-500 hover:brightness-110" : "bg-slate-600 cursor-not-allowed" ),
                      },
                      round < 4 ? "Next round" : "Vedi riepilogo"
                    )
                  ),
                  locked &&
                    React.createElement(
                      "div",
                      { className: "mt-4 p-4 rounded-2xl border border-slate-700 bg-slate-900/40" },
                      React.createElement("p", { className: "text-sm" }, "Accuratezza round: ", React.createElement("span", { className: "font-bold" }, scores[scores.length - 1], "%")),
                      React.createElement("p", { className: "text-xs text-slate-400" }, "(0% = molto lontano • 100% = perfetto)")
                    )
                )
              ),

            finished &&
              React.createElement(
                "div",
                { className: "mt-10" },
                React.createElement("h3", { className: "text-xl font-bold" }, "Riepilogo"),
                React.createElement("p", { className: "text-slate-300 mt-1" }, "Media: ",
                  React.createElement("span", { className: "font-extrabold" }, avg, "%"),
                  " su 5 round."
                ),
                React.createElement(
                  "div",
                  { className: "mt-4 grid md:grid-cols-5 gap-3" },
                  scores.map((sc, i) =>
                    React.createElement(
                      "div",
                      { key: i, className: "p-4 rounded-2xl border border-slate-700 bg-slate-900/40 text-center" },
                      React.createElement("div", { className: "text-xs text-slate-400" }, "Round ", i + 1),
                      React.createElement("div", { className: "text-2xl font-extrabold" }, sc, "%"),
                      React.createElement(
                        "div",
                        { className: "mt-2 h-3 rounded-full bg-slate-700 overflow-hidden" },
                        React.createElement("div", { className: "h-full", style: { width: sc + "%", background: "linear-gradient(to right, #22c55e, #3b82f6)" } })
                      )
                    )
                  )
                ),
                React.createElement(
                  "button",
                  { onClick: () => window.location.reload(), className: "mt-6 px-4 py-2 rounded-xl font-semibold shadow bg-emerald-500 hover:brightness-110" },
                  "Gioca di nuovo"
                )
              )
          )
        );
      }

      // Mount
      ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
    </script>
  </body>
</html>